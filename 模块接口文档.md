# Water CPU 模块接口文档

本文档描述了Water CPU项目中src文件夹下各个Verilog模块的功能和接口。

## 1. PC.v - 程序计数器模块

**功能描述**: 程序计数器模块，用于存储当前指令的地址。在时钟的正边沿更新PC值，支持复位功能。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| clk | input | 时钟信号 |
| rst | input | 复位信号（异步） |
| NPC | input [31:0] | 下一个PC值 |
| PC | output [31:0] | 当前PC值 |

## 2. alu.v - 算术逻辑单元

**功能描述**: 执行各种算术和逻辑运算，包括加法、减法、位运算、比较操作等，支持RISC-V指令集的ALU操作。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| A | input [31:0] | ALU输入操作数A |
| B | input [31:0] | ALU输入操作数B |
| ALUOp | input [4:0] | ALU操作控制码 |
| PC | input [31:0] | 程序计数器值（用于AUIPC指令） |
| C | output [31:0] | ALU运算结果 |
| Zero | output | 零标志位（结果为0时为1） |

## 3. ctrl.v - 控制单元

**功能描述**: 主控制器，根据指令的操作码、功能码等字段生成各种控制信号，支持R型、I型、S型、B型、U型、J型指令以及异常处理。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| Op | input [6:0] | 指令操作码 |
| Funct7 | input [6:0] | 指令功能码7位 |
| Funct3 | input [2:0] | 指令功能码3位 |
| Zero | input | ALU零标志输入 |
| RegWrite | output | 寄存器写使能信号 |
| MemWrite | output | 内存写使能信号 |
| EXTOp | output [5:0] | 立即数扩展控制信号 |
| ALUOp | output [4:0] | ALU操作控制信号 |
| NPCOp | output [2:0] | 下一个PC操作控制信号 |
| ALUSrc | output | ALU源操作数选择信号 |
| GPRSel | output [1:0] | 通用寄存器选择信号 |
| WDSel | output [1:0] | 写数据选择信号 |
| DMType | output [2:0] | 数据内存类型控制信号 |
| SCAUSE | output [7:0] | 异常原因码 |
| int_ret | output | 中断返回信号 |

## 4. ctrl_encode_def.v - 控制信号编码定义

**功能描述**: 定义文件，包含所有控制信号的编码常量定义，为其他模块提供统一的编码标准。

> 此文件为纯定义文件，无模块接口

## 5. dm_ctrol.v - 数据内存控制模块

**功能描述**: 数据内存访问控制器，处理不同数据类型（字节、半字、字）的读写操作，支持有符号和无符号数据访问。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| mem_w | input | 内存写使能信号 |
| Addr_in | input [31:0] | 输入地址 |
| dm_ctrl | input [2:0] | 数据内存控制信号 |
| Data_read_from_dm | input [31:0] | 从数据内存读取的原始数据 |
| Data_write | input [31:0] | 要写入的数据 |
| Data_read | output [31:0] | 处理后的读数据 |
| Data_write_to_dm | output [31:0] | 写入数据内存的数据 |
| wea_mem | output [3:0] | 内存写使能掩码 |

## 6. ExceptionCtrl.v - 异常控制模块

**功能描述**: 异常和中断控制单元，管理中断信号、异常级别设置，并根据中断屏蔽和状态寄存器确定中断处理。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| rst | input | 复位信号 |
| clk | input | 时钟信号 |
| STATUS | input [7:0] | 状态寄存器 |
| SCAUSE | input [7:0] | 异常原因输入 |
| INTMASK | input [7:0] | 中断屏蔽寄存器 |
| Int | input | 外部中断信号 |
| int_ret | input | 中断返回信号 |
| EXL_Set | output | 异常级别设置信号 |
| INT_Signal | output | 中断信号 |
| INT_PEND | output [2:0] | 中断挂起编号 |

## 7. EXT.v - 立即数扩展模块

**功能描述**: 立即数符号扩展单元，根据不同的指令类型对立即数进行符号扩展或零扩展，支持I型、S型、B型、U型、J型指令格式。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| iimm_shamt | input [4:0] | I型移位量立即数 |
| iimm | input [11:0] | I型立即数 |
| simm | input [11:0] | S型立即数 |
| bimm | input [11:0] | B型立即数 |
| uimm | input [19:0] | U型立即数 |
| jimm | input [19:0] | J型立即数 |
| EXTOp | input [5:0] | 扩展操作控制信号 |
| immout | output [31:0] | 扩展后的32位立即数 |

## 8. forwarding.v - 数据前推模块

**功能描述**: 流水线数据前推单元，检测和解决流水线中的数据冒险，通过前推机制避免流水线停顿。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| MEM_RegWrite | input | MEM阶段寄存器写使能 |
| MEM_rd | input [4:0] | MEM阶段目标寄存器地址 |
| WB_RegWrite | input | WB阶段寄存器写使能 |
| WB_rd | input [4:0] | WB阶段目标寄存器地址 |
| EX_rs1 | input [4:0] | EX阶段源寄存器1地址 |
| EX_rs2 | input [4:0] | EX阶段源寄存器2地址 |
| ForwardA | output [1:0] | 前推控制信号A |
| ForwardB | output [1:0] | 前推控制信号B |

## 9. GRE_array.v - 通用寄存器阵列

**功能描述**: 参数化的通用寄存器阵列，用于流水线寄存器的实现，支持写使能、冲刷等功能。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| Clk | input | 时钟信号 |
| Rst | input | 复位信号 |
| write_enable | input | 写使能信号 |
| flush | input | 冲刷信号 |
| in | input [WIDTH-1:0] | 输入数据（参数化宽度） |
| out | output [WIDTH-1:0] | 输出数据（参数化宽度） |

## 10. hazard.v - 冒险检测模块

**功能描述**: 流水线冒险检测单元，检测加载使用冒险、分支冒险和中断冒险，生成相应的停顿和冲刷信号。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| IF_ID_rs1 | input [4:0] | IF/ID阶段源寄存器1 |
| IF_ID_rs2 | input [4:0] | IF/ID阶段源寄存器2 |
| ID_EX_rd | input [4:0] | ID/EX阶段目标寄存器 |
| ID_EX_MemRead | input | ID/EX阶段内存读信号 |
| ID_EX_NPCOp | input [2:0] | ID/EX阶段NPC操作信号 |
| ID_EX_INT_Signal | input | ID/EX阶段中断信号 |
| stall | output | 流水线停顿信号 |
| IF_ID_flush | output | IF/ID寄存器冲刷信号 |
| PCWrite | output | PC写使能信号 |

## 11. NPC.v - 下一个程序计数器模块

**功能描述**: 下一个PC计算单元，根据不同的跳转类型（顺序、分支、跳转、中断等）计算下一个PC值，支持中断处理和异常返回。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| PC | input [31:0] | 当前PC值 |
| PC_EX | input [31:0] | EX阶段PC值 |
| NPCOp | input [2:0] | NPC操作控制信号 |
| IMM | input [31:0] | 立即数 |
| aluout | input [31:0] | ALU输出（用于JALR） |
| PCWrite | input | PC写使能信号 |
| INT_Signal | input | 中断信号 |
| EXL_Set | input | 异常级别设置信号 |
| INT_PEND | input [2:0] | 中断挂起编号 |
| clk | input | 时钟信号 |
| NPC | output [31:0] | 下一个PC值 |

## 12. RF.v - 寄存器文件模块

**功能描述**: 32个32位寄存器的寄存器文件，支持双端口读取和单端口写入，x0寄存器恒为0。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| clk | input | 时钟信号 |
| rst | input | 复位信号 |
| RFWr | input | 寄存器写使能 |
| A1 | input [4:0] | 读端口1地址 |
| A2 | input [4:0] | 读端口2地址 |
| A3 | input [4:0] | 写端口地址 |
| WD | input [31:0] | 写数据 |
| RD1 | output [31:0] | 读端口1数据 |
| RD2 | output [31:0] | 读端口2数据 |

## 13. SCPU.v - 单周期CPU顶层模块

**功能描述**: CPU的顶层模块，实现了5级流水线RISC-V处理器，集成了所有功能单元，支持指令执行、数据处理、异常处理和中断。

| 信号名 | 方向 | 描述 |
|--------|------|------|
| clk | input | 时钟信号 |
| rst | input | 复位信号 |
| MIO_ready | input | 内存/IO就绪信号 |
| inst_in | input [31:0] | 指令输入 |
| Data_in | input [31:0] | 数据内存输入 |
| INT | input | 外部中断信号 |
| mem_w | output | 内存写信号 |
| PC_out | output [31:0] | PC输出 |
| DMType | output [2:0] | 数据内存类型 |
| Addr_out | output [31:0] | 地址输出 |
| Data_out | output [31:0] | 数据输出 |
| CPU_MIO | output | CPU内存/IO信号 |

---

本文档生成于: $(date +"%Y年%m月%d日")
项目: Water CPU - RISC-V 流水线处理器
